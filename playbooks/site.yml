---
# Step-CA Deployment Playbook
# This is the main entry point for deploying step-ca

- name: Deploy Smallstep step-ca Certificate Authority
  hosts: ca_servers
  become: true

  pre_tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - step_ca_docker_init_password is defined
          - step_ca_docker_init_password | length >= 16
        fail_msg: >
          step_ca_docker_init_password must be defined and at least 16 characters.
          Set this in your vault or group_vars.

    - name: Display deployment information
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "  Deploying Smallstep step-ca"
          - "============================================"
          - "CA Name:      {{ step_ca_docker_init_name }}"
          - "DNS Names:    {{ step_ca_docker_init_dns | join(', ') }}"
          - "Bind Port:    {{ step_ca_docker_bind_port }}"
          - "Data Dir:     {{ step_ca_docker_data_dir }}"
          - "============================================"

  roles:
    - role: step_ca_docker

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "  step-ca Deployment Complete!"
          - "============================================"
          - ""
          - "CA is now running at: https://{{ step_ca_docker_init_dns | first }}:{{ step_ca_docker_bind_port }}"
          - ""
          - "To bootstrap a client:"
          - "  step ca bootstrap --ca-url https://{{ step_ca_docker_init_dns | first }}:{{ step_ca_docker_bind_port }} \\"
          - "    --fingerprint $(step certificate fingerprint {{ step_ca_docker_data_dir }}/certs/root_ca.crt)"
          - ""
          - "Root CA certificate: {{ step_ca_docker_data_dir }}/certs/root_ca.crt"
          - "============================================"
